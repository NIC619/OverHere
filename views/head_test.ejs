<meta charset="UTF-8">
<title><%= title %></title>
<link rel='stylesheet' href='/stylesheets/bootstrap.css' />
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<style type="text/css">
      html, body, #map-canvas { height: 100%; margin: 0; padding: 0;}
</style>
<script type="text/javascript">
    var map;
    var infoWindowList = [];
    var openedLocationList = [];
    
    function attachInfoWindow(marker, locationInfo) {
        var photoHtml = '<div>';
        for (var i in locationInfo.photoIDs){
            photoHtml += "<img src='/gallery/" + locationInfo.photoIDs[i] + "' \
            height='150' width='150' alt='Fail loading image...'>";
        }
        /*
        因為express已經設定static目錄為public，所以要取用gallery裡的照片不需再指定public如src='/public/gallery/xxx'
        */
        var hiddenForm = "<form id='hiddenForm' action='/newPhoto' method='POST' accept-charset='utf-8' enctype='multipart/form-data'>\
            <input type='hidden' name='id' value='" + locationInfo._id + "'>\
            <input type='file' name='img' accept='image/*' multiple><br>\
            <input type='button' id='button' value='Upload More Photos' onclick='addMarker(this.form)' /></form>";

        var infowindow = new google.maps.InfoWindow({
            content:    "Contributors: <b>" + locationInfo.name + "</b><br>\
                        <b>Lat</b>: " + marker.get('position').lat() + ", <b>Lng</b>: " + marker.getPosition().lng() + "<br>"
                        + photoHtml + "</div><br>" + hiddenForm
        });
        marker.addListener('click',function(){
            infowindow.open(marker.get('map'), marker);
        });
        marker.addListener('dblclick',function(){
            infowindow.close();
        });
    }

   	function loadMarkers() {
        
        for(var i in openedLocationList) {
            google.maps.event.trigger(openedLocationList[i]._marker, 'click');
        }
        openedLocationList.length = 0;

  		var xhttp = new XMLHttpRequest();
  		xhttp.onreadystatechange = function() {
    		if (xhttp.readyState == 4 && xhttp.status == 200) {
     			var location_list = JSON.parse(xhttp.responseText);
     			for(i in location_list){
		        	//console.log(location_list[i]);
                    if(location_list[i].dir == undefined) location_list[i].dir = "north";
                    var markerIcon = {
                        url: "/images/" + location_list[i].dir + ".png",
                        size: new  google.maps.Size(55,55),
                        origin: new google.maps.Point(0,-12)
                    }
		        	var marker = new google.maps.Marker({
		        		position: new google.maps.LatLng(location_list[i].lat, location_list[i].lng),
		        		map: map,
                        draggable: true,
                        icon: markerIcon,
		        		title: location_list[i].title
		        	});
                    attachInfoWindow(marker, location_list[i]);
        		}
    		}
  		};
  		xhttp.open("GET", "http://localhost:14741/ajax", true);
  		xhttp.send();
	}
    
    function clickMap(location) {
        var markerIcon = {
            url: "/images/north.png",
            size: new google.maps.Size(55,55),
            origin: new google.maps.Point(0,-12)
            //anchor: new google.maps.Point(0,55)
        }
        var marker = new google.maps.Marker({
            position: location,
            map: map,
            draggable: true,
            icon: markerIcon,
            title: "stage1"
        });
        
        var infoWindowContent = "<form id='formAddMarker' action='/newLocation' method='POST' accept-charset='utf-8' enctype='multipart/form-data'>\
            <b>Title</b>: <input type='text' name='title' size='10'><br>\
            <b>Lat</b>: " + marker.get('position').lat() + "<input type='hidden' name='lat' value='" + marker.get('position').lat() + "'  > , \
            <b>Lng</b>: " + marker.getPosition().lng() + "<input type='hidden' name='lng' value='" + marker.getPosition().lng() + "' ><br>\
            <b>Name</b>: <input type='text' id='name' name='name'><br>\
            In which direction should I look?<br>\
            <input type='radio' name='dir' value='north' checked><img src='/images/north.png' height='60' width='60' alt='North'/>\
            <input type='radio' name='dir' value='east'><img src='/images/east.png' height='60' width='60' alt='East'/>\
            <input type='radio' name='dir' value='west'><img src='/images/west.png' height='60' width='60' alt='West'/>\
            <input type='radio' name='dir' value='south'><img src='/images/south.png' height='60' width='60' alt='South'/><br>\
            <input type='file' name='img' accept='image/*' multiple><br>\
            <input type='button' id='button' value='Add' onclick='addMarker(this.form)' /></form>\
            <button onclick='showSurrounding(" + marker.getPosition().lat() + "," + marker.getPosition().lng() + ")'>";
    
        var infowindow = new google.maps.InfoWindow({
            content: infoWindowContent
        });
        infowindow.open(map, marker);
        //infoWindowList.push(infowindow);
        var tmpObj = { _marker : marker, _infoWindow : infowindow};
        openedLocationList.push(tmpObj);
        marker.addListener('click',function(){
            infowindow.close();
            marker.setMap(null);
        });
        
    }

    function addMarker(thisForm) {
        var formAddMarker = $(thisForm);
        var newf = new FormData(thisForm);
        /*
            結果是自己搞錯:FormData()是吃HTML element，當初沒發現FormData(thisForm)就可以用
            也有可能是當時伺服器端的multer沒弄好導致以為FormData(thisForm)不能用
        */
        
        $.ajax({
            type:   formAddMarker.attr('method'),
            url:    formAddMarker.attr('action'),
            cache: false,
            contentType: false,
            processData: false,
            data:   newf,
            success: function (res) {
                formAddMarker.find('#button').val(res);
                setTimeout(loadMarkers,1000);
            }
        });
    }

    function showSurrounding(_lat, _lng){
        console.log(_lat);
        $.ajax({
            type: "GET",
            url: "/surrounding",
            data: {
                lat: _lat,
                lng: _lng,
                range: 30
            },
            success: function(res) {
                console.log(res);
            }
        });
    }

    function initialize() {
        // Create a map object, and include the MapTypeId to add
        // to the map type control.
        var mapOptions = {
          center: { lat: 25.0193162, lng: 121.5414898},
          zoom: 8,
          mapTypeControlOptions: {
            mapTypeIds: [google.maps.MapTypeId.ROADMAP, google.maps.MapTypeId.HYBRID]    //, 'map_style']
          }
        };
        map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
        
        // Try HTML5 geolocation.
    		if (navigator.geolocation) {
      		navigator.geolocation.getCurrentPosition(function(position) {
      			//console.log(position);
  	      		var pos = {
  			        lat: position.coords.latitude,
  			        lng: position.coords.longitude
  	     		};
  		      	map.setCenter(pos);
  		    });
      		//}, function() {
        	//	handleLocationError(true, infoWindow, map.getCenter());
      		//});
    		} else {
      		// Browser doesn't support Geolocation
      		console.log('Browser doesn\'t support Geolocation');
      		//handleLocationError(false, infoWindow, map.getCenter());
   		  }

		loadMarkers();
        // This event listener will call clickMap() when the map is clicked.
        map.addListener('click', function(event) {
            //console.log(event);
            clickMap(event.latLng);
        });

    }

      
</script>
<script async defer
	src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBOugomkLdBEVv4wOb23mirFw8cTG_wz4o&callback=initialize">
</script>